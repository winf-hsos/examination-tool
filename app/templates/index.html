{% extends "base.html" %}

{% block title %}Übersicht · Examination Tool{% endblock %}

{% block content %}
  <page-header title="Übersicht">
    <template #lead>Dashboard</template>
    <template #subtitle>
      Alle wichtigen Kennzahlen zur Aufgabensammlung, den Kategorien und laufenden Prüfungen auf einen Blick.
    </template>
  </page-header>

  <div class="stat-grid">
    <stat-card
      title="Aufgaben"
      value="{{ tasks_count }}"
      description="Verfügbare Aufgaben in der Bibliothek"
      link-label="Aufgaben verwalten"
      link-href="/tasks"
      accent="indigo"
    >
      <template #icon>
        <span class="material-icons" aria-hidden="true">inventory_2</span>
      </template>
    </stat-card>
    <stat-card
      title="Kategorien"
      value="{{ category_tree|length }}"
      description="Hauptkategorien mit Unterstrukturen"
      link-label="Kategorien bearbeiten"
      link-href="/categories"
      accent="emerald"
    >
      <template #icon>
        <span class="material-icons" aria-hidden="true">category</span>
      </template>
    </stat-card>
    <stat-card
      title="Gruppen"
      value="{{ groups|length }}"
      description="Importierte Teams und Partnerpaare"
      link-label="Studierende importieren"
      link-href="/students/import"
      accent="amber"
    >
      <template #icon>
        <span class="material-icons" aria-hidden="true">groups</span>
      </template>
    </stat-card>
  </div>

  <section-block
    title="Prüfungskonfigurationen"
    subtitle="Plane die Struktur deiner Prüfungen und starte neue Sitzungen mit wenigen Klicks."
  >
    <template #actions>
      <a class="button small" href="/exam-configurations/new">Neue Konfiguration anlegen</a>
    </template>

    {% if not configurations %}
      <app-card class="config-card" variant="muted">
        <p class="text-muted">
          Es wurden noch keine Prüfungskonfigurationen erstellt. Lege eine neue Konfiguration an, um festzulegen,
          welche Kategorien und wie viele Aufgaben pro Kategorie in einer Prüfung verwendet werden sollen.
        </p>
        <a class="button secondary small" href="/exam-configurations/new">Jetzt konfigurieren</a>
      </app-card>
    {% else %}
      <div class="config-grid">
        {% for configuration in configurations %}
          <app-card class="config-card">
            <div class="config-card__header">
              <h3>{{ configuration.name }}</h3>
              <form
                method="post"
                action="/exam-configurations/{{ configuration.id }}/delete"
                onsubmit="return confirm('Konfiguration wirklich löschen?');"
              >
                <button class="button ghost small" type="submit">Löschen</button>
              </form>
            </div>
            <div class="config-card__meta">
              <span class="chip">Ø Schwierigkeit {{ '%.1f' % configuration.target_difficulty }}</span>
              <span class="badge">{{ configuration.requirements|length }} Kategorien</span>
            </div>
            <div class="config-card__requirements">
              {% for requirement in configuration.requirements %}
                <div>
                  <strong>{{ requirement.category.name }}</strong>
                  {% if requirement.subcategory %}· {{ requirement.subcategory.name }}{% endif %}
                  <span class="badge">{{ requirement.question_count }} Frage(n)</span>
                </div>
              {% endfor %}
            </div>
            <div class="config-card__footer">
              {% if has_groups %}
                <form class="inline-form" method="post" action="/exams">
                  <input type="hidden" name="configuration_id" value="{{ configuration.id }}" />
                  <label for="config-{{ configuration.id }}-group">Gruppe</label>
                  <select id="config-{{ configuration.id }}-group" name="group_id" required>
                    <option value="" disabled selected>Gruppe wählen</option>
                    {% for group in groups %}
                      <option value="{{ group.id }}">{{ group.label }}</option>
                    {% endfor %}
                  </select>
                  <button class="button small" type="submit">Prüfung starten</button>
                </form>
              {% else %}
                <p class="text-muted">
                  Noch keine Gruppen importiert. Verwende den Demomodus, um die Studierendenansicht zu testen.
                </p>
              {% endif %}
              <form class="inline-form" method="post" action="/exams">
                <input type="hidden" name="configuration_id" value="{{ configuration.id }}" />
                <input type="hidden" name="group_id" value="" />
                <label for="demo-{{ configuration.id }}">Demomodus</label>
                <input id="demo-{{ configuration.id }}" type="text" name="demo_label" value="Testmodus" />
                <button class="button secondary small" type="submit">Demo öffnen</button>
              </form>
            </div>
          </app-card>
        {% endfor %}
      </div>
    {% endif %}
  </section-block>

  <section-block
    title="Kategorien &amp; Struktur"
    subtitle="Organisiere deine Aufgabensammlung in klaren Themenbereichen."
  >
    {% if not category_tree %}
      <app-card variant="muted">
        <p class="text-muted">
          Es wurden noch keine Kategorien definiert. Lege Haupt- und Unterkategorien an, um Aufgaben übersichtlich zu
          strukturieren.
        </p>
        <a class="button ghost" href="/categories">Kategorien anlegen</a>
      </app-card>
    {% else %}
      <app-card>
        <ul class="category-tree">
          {% for category in category_tree %}
            <li>
              <strong>{{ category.name }}</strong>
              {% if category.children %}
                <ul>
                  {% for subcategory in category.children %}
                    <li>{{ subcategory.name }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </app-card>
    {% endif %}
  </section-block>

  <section-block
    title="Studierendenansicht"
    subtitle="Teile die Live-Ansicht mit deinen Studierenden – aktive Prüfungen werden automatisch angezeigt."
  >
    <app-card class="share-card">
      <p>
        Nutze diesen Link, um die Liveansicht für Studierende bereitzustellen. Die aktuell aktive Prüfung wird dort
        automatisch angezeigt.
      </p>
      <code class="share-link">{{ student_live_url }}</code>
      <div class="text-muted">
        {% if active_exam %}
          Aktive Prüfung: {{ active_exam.configuration.name if active_exam.configuration else 'Konfiguration unbekannt' }}{% if active_exam.group %}
            · {{ active_exam.group.label }}{% endif %} (gestartet am {{ active_exam.started_at.strftime('%d.%m.%Y %H:%M') }} Uhr)
        {% else %}
          Aktuell ist keine Prüfung aktiv.
        {% endif %}
      </div>
      <a class="button secondary" href="{{ student_live_url }}" target="_blank" rel="noopener">Studierendenansicht öffnen</a>
    </app-card>
  </section-block>

  {% if latest_exam %}
    <section-block
      title="Letzte Prüfung"
      subtitle="Behalte die zuletzt gestartete Sitzung im Blick."
    >
      <app-card>
        <p>
          {% if latest_exam.group %}
            Gruppe <strong>{{ latest_exam.group.label }}</strong>
          {% else %}
            <strong>Demomodus</strong>
          {% endif %}
          · {{ latest_exam.configuration.name if latest_exam.configuration else 'ohne Konfiguration' }}
          · gestartet am {{ latest_exam.started_at.strftime('%d.%m.%Y %H:%M') }} Uhr
        </p>
        <a class="button secondary" href="/exams/{{ latest_exam.id }}/teacher">Prüfung ansehen</a>
      </app-card>
    </section-block>
  {% endif %}
{% endblock %}
