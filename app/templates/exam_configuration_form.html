{% extends "base.html" %}

{% block title %}Neue Prüfungskonfiguration · Examination Tool{% endblock %}

{% block content %}
  <h1 class="page-title">Neue Prüfungskonfiguration</h1>

  <div class="card form-card">
    <div class="card-content">
      <form id="configuration-form" method="post" action="/exam-configurations">
        <input type="hidden" name="requirements_json" id="requirements-json" />

        <div class="row">
          <div class="input-field col s12 m6">
            <input id="configuration-name" name="name" type="text" placeholder="z. B. Abschlussklausur" required />
            <label for="configuration-name">Name der Konfiguration</label>
          </div>
          <div class="input-field col s12 m6">
            <label class="active" for="target-difficulty">Durchschnittliches Schwierigkeitsniveau</label>
            <input type="hidden" id="target-difficulty" name="target_difficulty" value="2" />
            <div
              class="difficulty-segmented"
              data-target-input="target-difficulty"
              data-display-target="target-difficulty-display"
            >
              <input type="radio" name="difficulty-choice" id="difficulty-1" value="1" data-label="Stufe 1 – Grundlagen" />
              <label for="difficulty-1">Stufe 1</label>
              <input
                type="radio"
                name="difficulty-choice"
                id="difficulty-2"
                value="2"
                data-label="Stufe 2 – Fortgeschritten"
                checked
              />
              <label for="difficulty-2">Stufe 2</label>
              <input type="radio" name="difficulty-choice" id="difficulty-3" value="3" data-label="Stufe 3 – Anspruchsvoll" />
              <label for="difficulty-3">Stufe 3</label>
            </div>
            <span class="helper-text" id="target-difficulty-display">Stufe 2 – Fortgeschritten</span>
          </div>
        </div>

        <div class="section" style="margin-top: 1.5rem;">
          <h2 class="card-title" style="font-size: 1.4rem;">Kategorien &amp; Anzahl Aufgaben</h2>
          <p class="text-muted" style="margin-bottom: 1.5rem;">
            Lege fest, aus welchen Kategorien wie viele Aufgaben automatisch gezogen werden sollen. Die Reihenfolge
            bestimmt zugleich die Priorität bei der Auswahl.
          </p>
          <div id="requirements-list" class="requirement-grid"></div>
          <button type="button" class="btn btn-secondary waves-effect" id="add-requirement">
            <span class="material-icons left" aria-hidden="true">add_circle</span>
            Kategorie hinzufügen
          </button>
        </div>

        <div class="form-actions">
          <a class="btn-flat waves-effect" href="/">Abbrechen</a>
          <button type="submit" class="btn waves-effect waves-light">Konfiguration speichern</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    const CATEGORY_OPTIONS = {{ category_options_json|safe }};

    document.addEventListener('DOMContentLoaded', () => {
      let requirementIndex = 0;
      const listEl = document.getElementById('requirements-list');
      const addBtn = document.getElementById('add-requirement');
      const requirementsInput = document.getElementById('requirements-json');

      function buildCategorySelect(selectedId) {
        const select = document.createElement('select');
        select.required = true;
        select.dataset.role = 'category';
        select.innerHTML = '<option value="" disabled selected>Kategorie wählen</option>';
        CATEGORY_OPTIONS.forEach((option) => {
          const opt = document.createElement('option');
          opt.value = option.id;
          opt.textContent = option.name;
          if (String(option.id) === String(selectedId)) {
            opt.selected = true;
          }
          select.appendChild(opt);
        });
        return select;
      }

      function buildSubcategorySelect(categoryId, selectedId) {
        const select = document.createElement('select');
        select.dataset.role = 'subcategory';
        select.innerHTML = '<option value="">Alle Unterkategorien</option>';
        const category = CATEGORY_OPTIONS.find((option) => String(option.id) === String(categoryId));
        if (category && category.subcategories) {
          category.subcategories.forEach((sub) => {
            const opt = document.createElement('option');
            opt.value = sub.id;
            opt.textContent = sub.name;
            if (String(sub.id) === String(selectedId)) {
              opt.selected = true;
            }
            select.appendChild(opt);
          });
        }
        return select;
      }

      function createInputField(id, labelText, element) {
        const wrapper = document.createElement('div');
        wrapper.className = 'input-field';
        element.id = id;
        wrapper.appendChild(element);
        const label = document.createElement('label');
        label.setAttribute('for', id);
        label.textContent = labelText;
        label.classList.add('active');
        wrapper.appendChild(label);
        return wrapper;
      }

      function createRequirementRow(initial) {
        requirementIndex += 1;
        const row = document.createElement('div');
        row.className = 'requirement-row';

        const categorySelect = buildCategorySelect(initial?.category_id);
        const categoryField = createInputField(`req-category-${requirementIndex}`, 'Kategorie', categorySelect);

        let subcategorySelect = buildSubcategorySelect(initial?.category_id, initial?.subcategory_id);
        let subcategoryField = createInputField(
          `req-subcategory-${requirementIndex}`,
          'Unterkategorie',
          subcategorySelect
        );

        const countInput = document.createElement('input');
        countInput.type = 'number';
        countInput.min = '1';
        countInput.value = initial?.question_count || 1;
        countInput.required = true;
        countInput.dataset.role = 'count';
        const countField = createInputField(`req-count-${requirementIndex}`, 'Aufgaben', countInput);

        const removeField = document.createElement('div');
        removeField.className = 'requirement-actions';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-flat waves-effect red-text text-darken-1';
        removeBtn.textContent = 'Entfernen';
        removeBtn.addEventListener('click', () => {
          row.remove();
        });
        removeField.appendChild(removeBtn);

        categorySelect.addEventListener('change', () => {
          const current = subcategorySelect.value;
          const replacement = buildSubcategorySelect(categorySelect.value, current);
          replacement.dataset.role = 'subcategory';
          const newField = createInputField(
            `req-subcategory-${requirementIndex}`,
            'Unterkategorie',
            replacement
          );
          row.replaceChild(newField, subcategoryField);
          subcategorySelect = replacement;
          subcategoryField = newField;
          window.AppUI?.refresh?.(newField);
        });

        row.append(categoryField, subcategoryField, countField, removeField);
        return row;
      }

      function addRequirement(initial) {
        const row = createRequirementRow(initial);
        listEl.appendChild(row);
        window.AppUI?.refresh?.(row);
      }

      addBtn.addEventListener('click', () => addRequirement());
      addRequirement();

      document.getElementById('configuration-form').addEventListener('submit', (event) => {
        const rows = Array.from(listEl.querySelectorAll('.requirement-row'));
        if (!rows.length) {
          event.preventDefault();
          M.toast({ html: 'Bitte füge mindestens eine Kategorie hinzu.', displayLength: 3000 });
          return;
        }
        const requirements = rows.map((row) => {
          const categorySelect = row.querySelector('[data-role="category"]');
          const subcategorySelect = row.querySelector('[data-role="subcategory"]');
          const countInput = row.querySelector('[data-role="count"]');
          return {
            category_id: categorySelect.value,
            subcategory_id: subcategorySelect.value || null,
            question_count: countInput.value || 1,
          };
        });
        if (requirements.some((req) => !req.category_id)) {
          event.preventDefault();
          M.toast({ html: 'Bitte wähle für jede Zeile eine Kategorie aus.', displayLength: 3000 });
          return;
        }
        requirementsInput.value = JSON.stringify(requirements);
      });
    });
  </script>
{% endblock %}
