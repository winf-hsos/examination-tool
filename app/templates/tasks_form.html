{% extends "base.html" %}

{% if task %}
  {% set page_title = 'Aufgabe bearbeiten' %}
{% else %}
  {% set page_title = 'Neue Aufgabe anlegen' %}
{% endif %}

{% block title %}{{ page_title }} · Examination Tool{% endblock %}

{% block head_extra %}
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css"
  />
{% endblock %}

{% block content %}
  <h1 class="page-title">{{ page_title }}</h1>

  <div class="card form-card">
    <div class="card-content">
      <form
        id="task-form"
        method="post"
        enctype="multipart/form-data"
        action="{% if task %}/tasks/{{ task.id }}{% else %}/tasks{% endif %}"
      >
        <input type="hidden" name="crop_metadata" id="crop-metadata" />

        <div class="row">
          <div class="input-field col s12 m6">
            <input id="title" type="text" name="title" value="{{ task.title if task else '' }}" required />
            <label for="title" {% if task %}class="active"{% endif %}>Titel</label>
          </div>
          <div class="input-field col s12 m6">
            <select id="category_id" name="category_id" required>
              <option value="" disabled {% if not selected_category_id %}selected{% endif %}>Kategorie wählen</option>
              {% for category in categories %}
                <option value="{{ category.id }}" {% if selected_category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
            </select>
            <label for="category_id">Kategorie</label>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12 m6">
            <select
              id="subcategory_id"
              name="subcategory_id"
              data-selected="{{ selected_subcategory_id if selected_subcategory_id else '' }}"
            >
              <option value="" {% if not selected_subcategory_id %}selected{% endif %}>Keine Unterkategorie</option>
              {% if selected_category_id %}
                {% for category in categories %}
                  {% if category.id == selected_category_id %}
                    {% for subcategory in category.children %}
                      <option value="{{ subcategory.id }}" {% if selected_subcategory_id == subcategory.id %}selected{% endif %}>{{ subcategory.name }}</option>
                    {% endfor %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            </select>
            <label for="subcategory_id">Unterkategorie</label>
          </div>
          <div class="input-field col s12 m6">
            <select id="difficulty" name="difficulty" required>
              <option value="1" {% if task and task.difficulty == 1 %}selected{% endif %}>1 · Grundlagen</option>
              <option value="2" {% if not task or task.difficulty == 2 %}selected{% endif %}>2 · Fortgeschritten</option>
              <option value="3" {% if task and task.difficulty == 3 %}selected{% endif %}>3 · Anspruchsvoll</option>
            </select>
            <label for="difficulty">Schwierigkeitsstufe</label>
          </div>
        </div>

        <div class="section">
          <h2 class="card-title" style="font-size: 1.4rem; margin-bottom: 1rem;">Inhalte</h2>
          <div class="input-field" style="margin-bottom: 1.5rem;">
            <textarea
              id="statement_markdown"
              name="statement_markdown"
              class="materialize-textarea"
              data-preview-target="statement-preview"
              required
            >{{ task.statement_markdown if task else '' }}</textarea>
            <label for="statement_markdown" class="active">Aufgabe (Markdown)</label>
          </div>
          <div class="markdown-preview" id="statement-preview"></div>
        </div>

        <div class="section" style="margin-top: 2rem;">
          <div class="input-field" style="margin-bottom: 1.5rem;">
            <textarea
              id="hints_markdown"
              name="hints_markdown"
              class="materialize-textarea"
              data-preview-target="hints-preview"
            >{{ task.hints_markdown if task and task.hints_markdown else '' }}</textarea>
            <label for="hints_markdown" class="active">Hinweise (optional)</label>
          </div>
          <div class="markdown-preview" id="hints-preview"></div>
        </div>

        <div class="section" style="margin-top: 2rem;">
          <div class="input-field" style="margin-bottom: 1.5rem;">
            <textarea
              id="solution_markdown"
              name="solution_markdown"
              class="materialize-textarea"
              data-preview-target="solution-preview"
            >{{ task.solution_markdown if task and task.solution_markdown else '' }}</textarea>
            <label for="solution_markdown" class="active">Lösung (optional)</label>
          </div>
          <div class="markdown-preview" id="solution-preview"></div>
        </div>

        <div class="row">
          <div class="input-field col s12 m6">
            <input
              id="dependency_ids"
              type="text"
              name="dependency_ids"
              value="{% if task and task.dependencies %}{% for dep in task.dependencies %}{{ dep.id }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}"
            />
            <label for="dependency_ids" class="active">Abhängigkeiten (IDs, Komma getrennt)</label>
            <span class="helper-text">z. B. 12, 18</span>
          </div>
          <div class="input-field col s12 m6">
            <input id="images" type="file" name="images" accept="image/*" multiple />
            <label for="images" class="active">Anhänge (Bilder)</label>
            <span class="helper-text">Bilder werden automatisch zugeschnitten (4:3) und skaliert.</span>
            <div class="task-media-preview" id="image-preview"></div>
          </div>
        </div>

        {% if task and task.images %}
          <div class="section" style="margin-top: 2rem;">
            <h3 style="margin-top: 0;">Vorhandene Bilder</h3>
            <div class="image-gallery">
              {% for image in task.images %}
                <figure>
                  <img src="{{ url_for('static', path=image.thumbnail_path or image.file_path) }}" alt="{{ image.original_filename }}" />
                  <figcaption>{{ image.original_filename }}</figcaption>
                  <label class="remove-toggle">
                    <input type="checkbox" name="remove_image_ids" value="{{ image.id }}" /> Entfernen
                  </label>
                </figure>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if all_tasks %}
          <div class="section" style="margin-top: 2rem;">
            <h3 style="margin-top: 0;">Verfügbare Aufgaben</h3>
            <div class="markdown-preview" style="max-height: 200px; overflow: auto;">
              {% for other in all_tasks %}
                #{{ other.id }} · {{ other.title }} ({{ other.category }})<br />
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <div class="form-actions">
          <a class="btn-flat waves-effect" href="/tasks">Abbrechen</a>
          <button type="submit" class="btn waves-effect waves-light">Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <div id="crop-modal" class="modal">
    <div class="modal-content">
      <h4>Bild zuschneiden</h4>
      <div class="crop-container">
        <img id="crop-image" alt="Vorschau zum Zuschnitt" />
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="modal-close btn-flat" id="crop-cancel">Abbrechen</button>
      <button type="button" class="btn waves-effect waves-light" id="crop-apply">Zuschnitt übernehmen</button>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const categoryOptions = {{ category_options_json | safe }};
      const categorySelect = document.getElementById('category_id');
      const subcategorySelect = document.getElementById('subcategory_id');

      if (categorySelect && subcategorySelect) {
        function repopulateSubcategories(selectedCategoryId) {
          const currentSelection = subcategorySelect.dataset.selected || '';
          subcategorySelect.innerHTML = '';
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Keine Unterkategorie';
          if (!currentSelection) {
            defaultOption.selected = true;
          }
          subcategorySelect.appendChild(defaultOption);

          const category = categoryOptions.find((entry) => entry.id === Number(selectedCategoryId));
          if (!category) {
            subcategorySelect.dataset.selected = '';
            delete subcategorySelect.dataset.mInitialized;
            window.AppUI?.initSelects?.(subcategorySelect.parentElement || document);
            return;
          }

          category.subcategories.forEach((subcategory) => {
            const option = document.createElement('option');
            option.value = String(subcategory.id);
            option.textContent = subcategory.name;
            if (String(subcategory.id) === currentSelection) {
              option.selected = true;
            }
            subcategorySelect.appendChild(option);
          });

          if (!category.subcategories.length) {
            subcategorySelect.dataset.selected = '';
          }

          delete subcategorySelect.dataset.mInitialized;
          window.AppUI?.initSelects?.(subcategorySelect.parentElement || document);
        }

        categorySelect.addEventListener('change', (event) => {
          subcategorySelect.dataset.selected = '';
          repopulateSubcategories(event.target.value);
        });

        repopulateSubcategories(categorySelect.value);
      }

      const imageInput = document.getElementById('images');
      const previewContainer = document.getElementById('image-preview');
      const cropModalElement = document.getElementById('crop-modal');
      const cropModal = window.M && window.M.Modal ? M.Modal.init(cropModalElement, { dismissible: false }) : null;
      const cropImage = document.getElementById('crop-image');
      const cropApply = document.getElementById('crop-apply');
      const cropCancel = document.getElementById('crop-cancel');
      const cropMetadataField = document.getElementById('crop-metadata');

      const cropQueue = [];
      const cropMetadata = {};
      let cropper = null;
      let modalIsOpen = false;

      function openCropModal() {
        if (!cropModal) {
          return;
        }
        cropModal.open();
        modalIsOpen = true;
      }

      function closeCropModal() {
        if (cropModal) {
          cropModal.close();
        }
        modalIsOpen = false;
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
      }

      function processCropQueue() {
        if (!cropQueue.length || !cropModal) {
          closeCropModal();
          return;
        }
        const current = cropQueue.shift();
        cropImage.src = current.dataUrl;
        openCropModal();
        requestAnimationFrame(() => {
          cropper = new Cropper(cropImage, {
            aspectRatio: 4 / 3,
            viewMode: 1,
            autoCropArea: 1,
          });
          cropApply.onclick = () => {
            const data = cropper.getData();
            cropMetadata[current.file.name] = {
              x: data.x,
              y: data.y,
              width: data.width,
              height: data.height,
            };
            closeCropModal();
            processCropQueue();
          };
          cropCancel.onclick = () => {
            delete cropMetadata[current.file.name];
            closeCropModal();
            processCropQueue();
          };
        });
      }

      function queueCrop(file, dataUrl) {
        if (!cropModal) {
          return;
        }
        cropQueue.push({ file, dataUrl });
        if (!cropper && !modalIsOpen) {
          processCropQueue();
        }
      }

      function renderPreviewThumbnail(file, dataUrl, requiresCrop) {
        const wrapper = document.createElement('div');
        wrapper.className = 'preview-thumb';
        const img = document.createElement('img');
        img.src = dataUrl;
        img.alt = file.name;
        wrapper.appendChild(img);
        if (requiresCrop) {
          const chip = document.createElement('span');
          chip.className = 'badge';
          chip.textContent = 'Zuschnitt empfohlen';
          wrapper.appendChild(chip);
        }
        previewContainer.appendChild(wrapper);
        if (!requiresCrop) {
          delete cropMetadata[file.name];
        }
      }

      if (imageInput) {
        imageInput.addEventListener('change', () => {
          previewContainer.innerHTML = '';
          cropQueue.length = 0;
          closeCropModal();
          Object.keys(cropMetadata).forEach((key) => delete cropMetadata[key]);
          Array.from(imageInput.files || []).forEach((file) => {
            const reader = new FileReader();
            reader.onload = (event) => {
              const dataUrl = event.target.result;
              const probe = new Image();
              probe.onload = () => {
                const ratio = probe.width / probe.height;
                const requiresCrop = Math.abs(ratio - 4 / 3) > 0.02;
                renderPreviewThumbnail(file, dataUrl, requiresCrop);
                if (requiresCrop) {
                  queueCrop(file, dataUrl);
                }
              };
              probe.src = dataUrl;
            };
            reader.readAsDataURL(file);
          });
        });
      }

      document.getElementById('task-form').addEventListener('submit', () => {
        cropMetadataField.value = JSON.stringify(cropMetadata);
      });
    });
  </script>
{% endblock %}
