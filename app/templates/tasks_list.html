{% extends "base.html" %}

{% block title %}Aufgaben · Examination Tool{% endblock %}

{% block content %}
  <div class="section-header">
    <h1 class="page-title">Aufgabenbibliothek</h1>
    <div>
      <a class="button secondary" href="/tasks/export">Exportieren</a>
      <a class="button" href="/tasks/new">Neue Aufgabe</a>
    </div>
  </div>

  {% if import_summary %}
    <div class="alert success">
      Import erfolgreich: {{ import_summary.tasks }} Aufgaben, {{ import_summary.categories }} Kategorien, {{ import_summary.subcategories }} Unterkategorien, {{ import_summary.images }} Bilder.
    </div>
  {% endif %}

  {% if not tasks %}
    <div class="card">
      <p>Noch keine Aufgaben vorhanden. Lege eine neue Aufgabe an oder importiere vorhandene Datensätze.</p>
    </div>
  {% else %}
    <div class="task-grid">
      {% for item in tasks %}
        {% set task = item.task %}
        <article class="task-card">
          <div class="task-card__image">
            {% if task.images %}
              {% set image = task.images[0] %}
              <img src="{{ url_for('static', path=image.thumbnail_path or image.file_path) }}" alt="Vorschaubild zu {{ task.title }}" />
            {% else %}
              <div class="task-card__placeholder">Schwierigkeit {{ task.difficulty }}</div>
            {% endif %}
          </div>
          <div class="task-card__body">
            <div class="task-card__meta">
              <span class="badge">{{ task.category }}{% if task.subcategory %} · {{ task.subcategory }}{% endif %}</span>
              <span class="chip chip--level-{{ task.difficulty }}">Schwierigkeit {{ task.difficulty }}</span>
              {% if task.dependencies %}
                <span class="badge">Voraussetzungen: {{ task.dependencies|length }}</span>
              {% endif %}
            </div>
            <h3 class="task-card__title">{{ task.title }}</h3>
            <div class="markdown-preview" style="max-height:180px; overflow:auto;">{{ item.statement_html|safe }}</div>
            <div class="task-card__actions">
              <a class="button secondary small" href="/tasks/{{ task.id }}/edit">Bearbeiten</a>
              <form method="post" action="/tasks/{{ task.id }}/copy">
                <button class="button small" type="submit">Kopie erstellen</button>
              </form>
              <form method="post" action="/tasks/{{ task.id }}/delete" onsubmit="return confirm('Aufgabe wirklich löschen?');">
                <button class="button danger small" type="submit">Löschen</button>
              </form>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}
